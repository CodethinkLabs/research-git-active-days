#!/usr/bin/env python
# Copyright (C) 2015  Codethink Limited
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>.

'''Calculate Git Active Days for one or more Git repositories.

The idea of the 'Git Active Days' metric was taken from the `git-summary` and
`git-effort` programs in <https://github.com/tj/git-extras>.

'''

import argparse
import os
import subprocess
import sys


def active_days(repo, refs):
    '''Returns the set of days where 'repo' had at least one commit.'''
    # List the author date for each commit.
    text = git_output(['git', 'log' , '--pretty=format:%ai'] + refs, cwd=repo)

    # Store all dates in a set, which will merge any duplicates.
    days = set()
    for line in text.splitlines():
        date, time, timezone = line.split()
        days.add(date)
    return days


def active_days_per_author(repo, refs):
    '''Return the list of active days in 'repo' for each commit author.

    For example, if Fred made four commits on Monday, and Suzie committed once
    on Monday and Tuesday, you will get 3 results: Fred was active Monday,
    and Suzie was active Monday and Tuesday.

    '''
    # List author email and author date for each commit.
    # In theory, any character could appear in the email address
    # so we should use \0 as a separator, or something.
    # See: https://tools.ietf.org/html/rfc3696#section-3
    text = git_output(['git', 'log' , '--pretty=format:%ae:%ai'] + refs, cwd=repo)

    # Store all (email, date) pairs in a set, which will merge any duplicates.
    author_days = set()
    for line in text.splitlines():
        author_email, datetime = line.split(':', 1)
        date, time, timezone = datetime.split()
        author_days.add((author_email, date))
    return author_days


def git_output(args, cwd=None):
    try:
        text = subprocess.check_output(args, cwd=cwd, stderr=subprocess.STDOUT)
    except subprocess.CalledProcessError as e:
        raise RuntimeError("Git command failed, with output:\n%s" % e.output)
    return text.decode('unicode-escape')


def check_refs_exist(repo, refs):
    missing = []
    for ref in refs:
        if ref != '--all':
            with open(os.devnull, 'w') as f:
                result = subprocess.call(
                    ['git', 'rev-parse', '--verify', ref], stderr=f, stdout=f)
            if result != 0:
                missing.append(ref)
    if len(missing) > 0:
        raise RuntimeError(
            "Did not find refs %s in repo %s" % (', '.join(refs), repo))


def argument_parser():
    parser = argparse.ArgumentParser(
        description="Counts days where commits were made, across one or more "
                    "Git repositories.")

    #parser.add_argument(
    #    '--filter-author-email', metavar='PATTERN', nargs=1, type=str,
    #    help="only count commits where the author email matches a glob "
    #         "pattern")

    # It might be clearer to have the inverse of this option instead
    # (--combine-authors), but it's nice to have the default behaviour be
    # the same as that of `git-summary` and `git-effort`.
    parser.add_argument(
        '--per-author', action='store_true',
        help="count commits per author on each day, not just number of days")

    # This works by injecting the '--all' commandline option into the list of
    # refs, which we pass straight through to `git log`.
    parser.add_argument(
        '--all-refs', action='store_const', dest='refs', const=['--all'],
        help="measure all commits in all Git refs")

    parser.add_argument(
        '--ref', metavar='REF', action='append', dest='refs',
        help="a Git ref pattern to measure. Default is to measure HEAD.")

    parser.add_argument(
        'repos', metavar='<repo>', type=str, nargs='*',
        help="Path to one or more Git repos. Where there are multiple repos, "
             "an 'active day' is one where there was a commit in any of those "
             "repos. If no paths are given, the current directory is used.")

    return parser


def main():
    args = argument_parser().parse_args()

    if len(args.repos) == 0:
        args.repos = ['.']

    if args.refs is None:
        args.refs = ['HEAD']
    else:
        for repo in args.repos:
            check_refs_exist(repo, args.refs)

    result = None

    if args.per_author:
        all_author_days = set()
        for repo in args.repos:
            author_days = active_days_per_author(repo, refs=args.refs)
            all_author_days.update(author_days)
        result = len(all_author_days)
    else:
        all_days = set()
        for repo in args.repos:
            days = active_days(repo, refs=args.refs)
            all_days.update(days)
        result = len(all_days)

    print(result)


try:
    main()
except RuntimeError as e:
    sys.stderr.write('ERROR: %s\n' % e)
    sys.exit(1)
